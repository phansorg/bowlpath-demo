# bowlpath-demo

## 1. プロジェクト概要

- **目的:**  
  動画ファイルからボウリングのボールを検出・追跡し、その軌跡を可視化するツールを開発する。最終的には、動画に軌跡オーバーレイを表示するか、別途軌跡を描画した画像/グラフとして出力する。

- **対象環境:**  
  - Windows OS  
  - CUDA 11.8（GPUアクセラレーション用）  
  - Cursorエディタによる詳細操作

- **使用技術:**  
  Python（OpenCV、PyTorch/TensorFlow、NumPy、Matplotlibなど）、CUDAを利用した高速処理

---

## 2. システム構成

### 2.1. モジュール構成

1. **入力モジュール**  
   - 動画ファイルの読み込み（OpenCVの`cv2.VideoCapture`を利用）
   - フレーム単位での処理に対応

2. **前処理モジュール**  
   - フレームのリサイズ、正規化、必要に応じたノイズ除去

3. **ボール検出モジュール**  
   - **モデル選定:**  
     事前学習済みの物体検出モデル（例: YOLO、SSDなど）を使用し、ボウリングのボールに特化したファインチューニングも検討  
   - **CUDA利用:**  
     GPU上での推論により高速処理を実現

4. **追跡モジュール**  
   - 検出されたボールの位置をフレーム間で追跡  
   - シンプルなKalmanフィルタやSORT/Deep SORTアルゴリズムの導入を検討

5. **軌跡計算・可視化モジュール**  
   - 各フレームのボール座標から軌跡（連続した点の系列）を算出  
   - OpenCVやMatplotlibを用いて動画上に軌跡をオーバーレイ表示、または別途プロット画像として出力

6. **出力モジュール**  
   - 軌跡を描画した動画の保存（OpenCVの`cv2.VideoWriter`）  
   - 静止画としてのプロット保存（Matplotlibの`savefig`など）

---

## 3. ツールおよびライブラリ

- **主要ライブラリ:**  
  - **OpenCV:** 動画の入出力、フレーム処理、描画処理に利用  
  - **PyTorch/TensorFlow:** 物体検出モデルの推論（CUDAによる高速化）  
  - **NumPy:** 数値計算、データ操作  
  - **Matplotlib:** 軌跡グラフの描画
- **開発環境:**  
  - Python (最新の3.x系推奨)  
  - CUDA 11.8環境下でのPyTorch/TensorFlow（GPU版）のインストール
- **エディタ:**  
  - Cursorエディタを用いてコードの作成、デバッグ、管理

---

## 4. 詳細設計

### 4.1. ワークフロー

1. **動画読み込み:**  
   - OpenCVで動画ファイルを読み込み、各フレームを取得する。

2. **前処理:**  
   - 必要に応じてフレームのリサイズや正規化を行う。
  
3. **ボール検出:**  
   - 各フレームを検出モデルに入力し、ボウリングボールの候補領域と信頼度を出力。  
   - CUDAを利用してリアルタイムまたは高速な推論を実現。

4. **ボール追跡:**  
   - フレーム間の検出結果を連携し、同一のボールを追跡。  
   - ノイズ除去や補間処理も実施し、安定した軌跡情報を生成。

5. **軌跡描画:**  
   - 各フレームに対して、これまでのボール位置をオーバーレイ表示（例: 軌跡線、点など）  
   - または、全フレームの位置データを基にMatplotlibで軌跡グラフを生成。

6. **結果の保存:**  
   - 解析結果を動画または静止画として出力し、保存する。

### 4.2. コード構成（例）

```
/project-root
 ├── src/
 │    ├── main.py         # エントリーポイント
 │    ├── detector.py     # 物体検出モジュール
 │    ├── tracker.py      # 追跡アルゴリズム実装
 │    ├── visualizer.py   # 軌跡描画・可視化モジュール
 │    └── utils.py        # 共通関数、前処理、設定管理など
 ├── tests/               # 単体テスト、統合テスト
 ├── docs/                # 設計書、マニュアル等
 └── requirements.txt     # 必要ライブラリの一覧
```

### 4.3. CUDA利用のポイント

- PyTorch/TensorFlowをCUDA版でインストールし、推論時に`device = "cuda"`を指定  
- フレームのバッチ処理（複数フレームを一括で推論）によるパフォーマンス向上を検討  
- GPUメモリの使用状況を監視し、効率的な処理を行う

### 4.4. 開発フローとCursorエディタの活用

- **Cursorエディタでの作業:**  
  - コードの各モジュール（detector.py、tracker.py、visualizer.pyなど）を分割して作成・編集  
  - Gitなどのバージョン管理ツールと連携し、変更履歴を管理
  - Cursorエディタの補完機能やデバッグツールを活用して、GPU処理やリアルタイム動作の確認を行う

- **デバッグとテスト:**  
  - 各モジュールごとにユニットテストを作成  
  - 実際の動画を用いてエンドツーエンドの動作確認を実施し、検出精度や追跡の安定性を評価

---

## 5. スケジュールとマイルストーン

| マイルストーン                | 内容                                       | 目安期間      |
|-----------------------------|------------------------------------------|------------|
| **環境構築とセットアップ**      | CUDA 11.8、Python、必要ライブラリのインストール、Cursorエディタ設定 | 1日         |
| **動画入出力モジュールの実装**    | OpenCVを用いた動画の読み込み、フレーム分割処理              | 1〜2日      |
| **ボール検出モジュールの実装**    | 事前学習済みモデルの選定、検出処理の実装（CUDA推論の確認）        | 2〜3日      |
| **追跡アルゴリズムの実装**      | シンプルな追跡アルゴリズム（例: Kalman filter, SORT）の実装         | 2日         |
| **軌跡可視化モジュールの実装**    | フレームオーバーレイおよび、Matplotlibによるグラフ生成              | 1〜2日      |
| **統合テストとデバッグ**       | 各モジュールの統合、実動画での動作検証、パフォーマンス評価          | 2〜3日      |
| **ドキュメント作成と最終調整**    | 使用方法、コード解説、READMEの整備                         | 1日         |

---

## 6. 追加検討事項

- **検出精度の向上:**  
  もしボウリングボール検出が困難な場合、専用のデータセットでファインチューニングを検討する。  

- **ユーザーインターフェース:**  
  将来的にGUI（例: TkinterやPyQt）を追加し、操作性を向上させる拡張も可能。  

- **拡張性:**  
  ボウリング以外のスポーツの球体追跡にも応用できるモジュール設計を意識する。  

---

## 7. まとめ

この計画・設計書は、Windows環境かつCUDA 11.8のセットアップ済み環境下で、ボウリングのボール軌跡可視化プログラムを構築するための全体像を示しています。各モジュールを分割し、Cursorエディタでの詳細操作およびデバッグを前提として、段階的に開発・統合していく方針です。

この設計をもとに、実際の実装に取り掛かる準備が整います。さらなる詳細やコード実装の際に、必要に応じて調整・拡充を行ってください。